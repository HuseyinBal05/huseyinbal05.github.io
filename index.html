<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personalized PDF Watermarker</title>
    <!-- Load Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Load required JavaScript libraries --><!-- PDF-LIB: For creating and editing PDFs --><script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
    <!-- SHEETJS (XLSX): For reading Excel and CSV files --><script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <!-- JSZIP: For creating the final .zip file --><script src="https://cdn.jsdelivr.net/npm/jszip/dist/jszip.min.js"></script>
    <style>
        /* Updated font stack for a more modern feel */
        body {
            font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
        }
        /* Custom styles for the file input */
        .file-input-label {
            display: block;
            padding: 16px 24px; /* More padding */
            background-color: #ffffff; /* White background for input area */
            border: 2px dashed #cbd5e1; /* Soft gray dashed border */
            border-radius: 12px; /* Slightly more rounded corners */
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05); /* Subtle shadow */
        }
        .file-input-label:hover {
            background-color: #f8fafc; /* Lighter hover background */
            border-color: #94a3b8; /* Darker border on hover */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* More pronounced shadow on hover */
        }
        .file-input-label strong {
            display: block; /* Ensure strong is block for spacing */
            font-size: 1rem; /* Slightly larger text */
            color: #2563eb; /* Blue text for main prompt */
            margin-bottom: 4px; /* Space between strong and span */
        }
        .file-input-label span {
            font-size: 0.875rem; /* Standard smaller text */
            color: #64748b; /* Soft gray for description */
        }
        /* Hide the actual file input */
        input[type="file"] {
            display: none;
        }
        /* Style for disabled button */
        #generateButton:disabled {
            background-color: #93c5fd; /* Lighter blue when disabled */
            cursor: not-allowed;
            box-shadow: none;
        }
    </style>
    <!-- Google Fonts - Inter for better typography --><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen flex items-center justify-center p-6">

    <div class="bg-white w-full max-w-2xl p-10 rounded-2xl shadow-xl border border-gray-100">
        <h1 class="text-4xl font-extrabold text-center text-gray-900 mb-4">
            PDF Watermarker
        </h1>
        <p class="text-center text-gray-600 mb-10 text-lg">
            Create personalized watermarks on PDFs from a list of names. All processing is secure and done in your browser.
        </p>

        <div class="space-y-8">
            <!-- Step 1: Upload PDF --><div>
                <label for="pdfFile" class="text-xl font-semibold text-gray-800 mb-3 block">Step 1: Upload your Base PDF</label>
                <label for="pdfFile" class="file-input-label">
                    <strong id="pdfFileName">Select PDF file to watermark</strong>
                    <span>Only .pdf files are accepted</span>
                </label>
                <input type="file" id="pdfFile" accept=".pdf">
            </div>

            <!-- Step 2: Upload Excel/CSV --><div>
                <label for="excelFile" class="text-xl font-semibold text-gray-800 mb-3 block">Step 2: Upload your List of People</label>
                <label for="excelFile" class="file-input-label">
                    <strong id="excelFileName">Select Excel or CSV file</strong>
                    <span>(.xlsx, .xls, .csv files accepted)</span>
                </label>
                <input type="file" id="excelFile" accept=".xlsx, .xls, .csv">
            </div>

            <!-- Step 3: Column Name --><div>
                <label for="columnName" class="text-xl font-semibold text-gray-800 mb-3 block">Step 3: Specify Name Column</label>
                <input type="text" id="columnName" placeholder="e.g., 'Full Name' or 'Participant ID'" class="w-full px-5 py-3 border border-gray-300 rounded-lg focus:ring-4 focus:ring-blue-200 focus:border-blue-400 outline-none transition text-gray-700 placeholder-gray-400 text-lg">
                <p class="text-sm text-gray-500 mt-2">
                    Enter the exact header name of the column containing the names (case-insensitive).
                </p>
            </div>

            <!-- Step 4: Opacity Slider --><div>
                <label for="opacitySlider" class="text-xl font-semibold text-gray-800 mb-3 block">Step 4: Adjust Watermark Opacity</label>
                <div class="flex items-center space-x-4">
                    <input type="range" id="opacitySlider" min="1" max="15" value="7" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600">
                    <span id="opacityValue" class="text-lg font-medium text-gray-700 w-12 text-right">0.07</span>
                </div>
                <p class="text-sm text-gray-500 mt-2">
                    Lower is more transparent, higher is more visible. (Default: 0.07)
                </p>
            </div>

            <!-- Generate Button --><button id="generateButton" class="w-full bg-blue-600 text-white font-bold py-4 px-8 rounded-xl text-xl hover:bg-blue-700 transition shadow-lg hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-blue-300">
                Generate Watermarked PDFs
            </button>

            <!-- Status Area --><div id="status" class="text-center text-gray-600 font-medium pt-4 text-lg" style="display: none;">
                Working...
            </div>
        </div>
    </div>

    <script>
        const { PDFDocument, StandardFonts, rgb, degrees } = PDFLib;
        
        const pdfFileInput = document.getElementById('pdfFile');
        const excelFileInput = document.getElementById('excelFile');
        const pdfFileName = document.getElementById('pdfFileName');
        const excelFileName = document.getElementById('excelFileName');
        const columnNameInput = document.getElementById('columnName');
        const generateButton = document.getElementById('generateButton');
        const status = document.getElementById('status');
        const opacitySlider = document.getElementById('opacitySlider');
        const opacityValue = document.getElementById('opacityValue');

        pdfFileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                pdfFileName.textContent = e.target.files[0].name;
            } else {
                pdfFileName.textContent = 'Select PDF file to watermark';
            }
        });

        excelFileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                excelFileName.textContent = e.target.files[0].name;
            } else {
                excelFileName.textContent = 'Select Excel or CSV file';
            }
        });

        opacitySlider.addEventListener('input', (e) => {
            const opacity = (e.target.value / 100).toFixed(2);
            opacityValue.textContent = opacity;
        });

        generateButton.addEventListener('click', handleGeneration);

        function readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = (e) => reject(e);
                reader.readAsArrayBuffer(file);
            });
        }

        async function addWatermark(page, text, font, opacity) {
            const { width, height } = page.getSize();
            const textSize = 40; // Reduced text size (was 55)
            
            const options = {
                size: textSize,
                font: font,
                color: rgb(0.5, 0.5, 0.5), 
                opacity: opacity, // Use opacity from slider
                rotate: degrees(45), 
            };

            // Increased spacing for a less dense, less distracting look
            for (let y = -height; y < height * 2; y += 250) { // Was 150
                for (let x = -width; x < width * 2; x += 350) { // Was 250
                    page.drawText(text, { ...options, x, y });
                }
            }
        }

        async function handleGeneration() {
            const pdfFile = pdfFileInput.files[0];
            const excelFile = excelFileInput.files[0];
            const columnName = columnNameInput.value.trim();
            const opacity = parseFloat(opacitySlider.value) / 100;

            if (!pdfFile || !excelFile || !columnName) {
                updateStatus('Please provide a PDF, a list of people, and a column name.', true);
                return;
            }

            generateButton.disabled = true;
            generateButton.textContent = 'Processing...';
            updateStatus('Starting process...');

            try {
                // Font loading is instant for standard font, no specific status needed here.

                updateStatus('Reading list of people...');
                const excelData = await readFileAsArrayBuffer(excelFile);
                const workbook = XLSX.read(excelData, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);

                if (!jsonData || jsonData.length === 0) {
                    throw new Error("The list of people file is empty or could not be read.");
                }

                const headers = Object.keys(jsonData[0]);
                const foundHeader = headers.find(h => h.trim().toLowerCase() === columnName.toLowerCase());

                if (!foundHeader) {
                    throw new Error(`Column "${columnName}" not found. Available columns are: ${headers.map(h => `"${h}"`).join(', ')}`);
                }

                const names = jsonData
                    .map(row => row[foundHeader])
                    .filter(name => name); 

                if (names.length === 0) {
                    throw new Error(`Found column "${foundHeader}", but it contains no names.`);
                }
                
                updateStatus(`Found ${names.length} names. Loading PDF template...`);

                const pdfBytes = await readFileAsArrayBuffer(pdfFile);
                const zip = new JSZip();
                updateStatus('Applying watermarks...');

                for (let i = 0; i < names.length; i++) {
                    const name = String(names[i]);
                    // Only replace characters that are explicitly invalid for filenames across OS
                    const sanitizedName = name.replace(/[\\/:*?"<>|]/g, '_').trim();
                    
                    updateStatus(`Watermarking for ${i + 1} of ${names.length}: ${name}`);

                    const pdfDoc = await PDFDocument.load(pdfBytes);
                    const standardFont = await pdfDoc.embedFont(StandardFonts.Helvetica);
                    
                    const pages = pdfDoc.getPages();

                    for (const page of pages) {
                        await addWatermark(page, name, standardFont, opacity);
                    }

                    const newPdfBytes = await pdfDoc.save();

                    zip.file(`${sanitizedName}_${pdfFile.name}`, newPdfBytes);
                }

                updateStatus('Generating ZIP file... This may take a moment.');
                const zipBlob = await zip.generateAsync({ type: 'blob', compression: 'DEFLATE', compressionOptions: { level: 9 } });

                const link = document.createElement('a');
                link.href = URL.createObjectURL(zipBlob);
                link.download = `watermarked_pdfs_${new Date().toISOString().slice(0,10)}.zip`; // Dynamic filename
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href); // Clean up URL object

                updateStatus(`Done! ${names.length} personalized PDFs generated and zipped.`);

            } catch (error) {
                console.error(error);
                updateStatus(`Error: ${error.message}`, true);
            } finally {
                generateButton.disabled = false;
                generateButton.textContent = 'Generate Watermarked PDFs';
            }
        }
        
        function updateStatus(message, isError = false) {
            status.textContent = message;
            status.style.display = 'block';
            status.style.color = isError ? '#dc2626' : '#475569'; /* Red for error, slate-600 for normal */
        }

    </script>
</body>
</html>







