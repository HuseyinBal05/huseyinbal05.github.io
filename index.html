<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personalized PDF Watermarker</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load required JavaScript libraries -->
    <!-- PDF-LIB: For creating and editing PDFs -->
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
    <!-- FONTKIT: Removed as we are using standard fonts -->
    <!-- SHEETJS (XLSX): For reading Excel and CSV files -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <!-- JSZIP: For creating the final .zip file -->
    <script src="https://cdn.jsdelivr.net/npm/jszip/dist/jszip.min.js"></script>
    <style>
        /* Reverted to standard system font */
        body {
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
        }
        /* Custom styles for the file input */
        .file-input-label {
            display: block;
            padding: 12px 20px;
            background-color: #f3f4f6;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        .file-input-label:hover {
            background-color: #e5e7eb;
            border-color: #9ca3af;
        }
        .file-input-label span {
            display: block;
            font-size: 0.875rem;
            color: #4b5563;
        }
        .file-input-label strong {
            color: #1f2937;
        }
        /* Hide the actual file input */
        input[type="file"] {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white w-full max-w-2xl p-8 rounded-xl shadow-lg">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">
            Personalized PDF Watermarker
        </h1>
        <p class="text-center text-gray-600 mb-8">
            Create personalized watermarks on a PDF from a list of names in an Excel/CSV file. All processing is done in your browser.
        </p>

        <div class="space-y-6">
            <!-- Step 1: Upload PDF -->
            <div>
                <label for="pdfFile" class="text-lg font-semibold text-gray-700 mb-2 block">Step 1: Upload your PDF</label>
                <label for="pdfFile" class="file-input-label">
                    <strong id="pdfFileName">Click to upload PDF file</strong>
                    <span>(.pdf)</span>
                </label>
                <input type="file" id="pdfFile" accept=".pdf">
            </div>

            <!-- Step 2: Upload Excel/CSV -->
            <div>
                <label for="excelFile" class="text-lg font-semibold text-gray-700 mb-2 block">Step 2: Upload your list of people</label>
                <label for="excelFile" class="file-input-label">
                    <strong id="excelFileName">Click to upload list of people</strong>
                    <span>(.xlsx, .xls, .csv)</span>
                </label>
                <input type="file" id="excelFile" accept=".xlsx, .xls, .csv">
            </div>

            <!-- Step 3: Column Name -->
            <div>
                <label for="columnName" class="text-lg font-semibold text-gray-700 mb-2 block">Step 3: Enter Name Column</label>

                <input type="text" id="columnName" placeholder="e.g., 'Full Name' or 'Email'" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition">
                <p class="text-sm text-gray-500 mt-2">
                    Name of the column in your file that contains the names. (Case-insensitive)
                </p>
            </div>

            <!-- Generate Button -->
            <button id="generateButton" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg text-lg hover:bg-blue-700 transition shadow-md disabled:opacity-50 disabled:cursor-not-allowed">
                Generate Watermarked PDFs
            </button>

            <!-- Status Area -->
            <div id="status" class="text-center text-gray-600 font-medium pt-4" style="display: none;">
                Working...
            </div>
        </div>
    </div>

    <script>
        // Get references to all libraries (loaded from CDN)
        const { PDFDocument, StandardFonts, rgb, degrees } = PDFLib;
        // fontkit (removed), XLSX, and JSZip are available on the window object
        
        // Get DOM elements
        const pdfFileInput = document.getElementById('pdfFile');
        const excelFileInput = document.getElementById('excelFile');
        const pdfFileName = document.getElementById('pdfFileName');
        const excelFileName = document.getElementById('excelFileName');
        const columnNameInput = document.getElementById('columnName');
        const generateButton = document.getElementById('generateButton');
        const status = document.getElementById('status');

        /* Removed unused global variables: originalPdfBytes and namesList */

        // Update file input labels with selected file names
        pdfFileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                pdfFileName.textContent = e.target.files[0].name;
            } else {
                pdfFileName.textContent = 'Click to upload PDF file';
            }
        });

        excelFileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                excelFileName.textContent = e.target.files[0].name;
            } else {
                excelFileName.textContent = 'Click to upload list of people';
            }
        });

        // Main function attached to the button
        generateButton.addEventListener('click', handleGeneration);

        // Helper function to read a file as an ArrayBuffer
        function readFileAsArrayBuffer(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = (e) => reject(e);
                reader.readAsArrayBuffer(file);
            });
        }

        // Helper function to add tiled watermarks to a page
        async function addWatermark(page, text, font) {
            const { width, height } = page.getSize();
            const textSize = 50; // Watermark text size
            
            // Watermark properties
            const options = {
                size: textSize,
                font: font,
                color: rgb(0.5, 0.5, 0.5), // Medium gray
                opacity: 0.15, // Light opacity
                rotate: degrees(45), // Diagonal
            };

            // Tile the watermark across the page
            // We use nested loops to create a grid pattern
            // The coordinates are adjusted to cover the whole page even when rotated
            for (let y = -height; y < height * 2; y += 200) {
                for (let x = -width; x < width * 2; x += 300) {
                    page.drawText(text, { ...options, x, y });
                }
            }
        }

        // Main logic
        async function handleGeneration() {
            // 1. Get and validate inputs
            const pdfFile = pdfFileInput.files[0];
            const excelFile = excelFileInput.files[0];
            const columnName = columnNameInput.value.trim();

            if (!pdfFile || !excelFile || !columnName) {
                updateStatus('Please provide a PDF, a list of people, and a column name.', true);
                return;
            }

            // 2. Disable button and show loading
            generateButton.disabled = true;
            generateButton.textContent = 'Processing...';
            updateStatus('Starting...');

            try {
                // 2. Load standard font (no network request)
                /* Combined redundant status messages */
                updateStatus('Loading font...');

                // 3. Read Excel/CSV file
                updateStatus('Reading list of people...');
                const excelData = await readFileAsArrayBuffer(excelFile);
                const workbook = XLSX.read(excelData, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);

                if (!jsonData || jsonData.length === 0) {
                    throw new Error("The list of people file is empty or could not be read.");
                }

                // Get the actual headers from the first row of data
                const headers = Object.keys(jsonData[0]);
                
                // Find the matching header, ignoring case and whitespace
                const foundHeader = headers.find(h => h.trim().toLowerCase() === columnName.toLowerCase());

                if (!foundHeader) {
                    // Throw a more helpful error
                    throw new Error(`Column "${columnName}" not found. Available columns are: ${headers.map(h => `"${h}"`).join(', ')}`);
                }

                // 4. Extract names using the *found* header
                const names = jsonData
                    .map(row => row[foundHeader]) // Use the actual header name
                    .filter(name => name); // Filter out empty/undefined names

                if (names.length === 0) {
                    // This error is now more specific: the column was found, but it's empty.
                    throw new Error(`Found column "${foundHeader}", but it contains no names.`);
                }
                
                updateStatus(`Found ${names.length} names. Reading PDF...`);

                // 5. Read PDF file (as bytes)
                const pdfBytes = await readFileAsArrayBuffer(pdfFile);

                // 6. Initialize ZIP file
                const zip = new JSZip();
                updateStatus('Starting PDF watermarking...');

                // 7. Loop through each name and process PDF
                for (let i = 0; i < names.length; i++) {
                    const name = String(names[i]); // Ensure name is a string
                    // Reverted to basic sanitization
                    const sanitizedName = name.replace(/[^a-zA-Z0-9\s._-]/g, '_');
                    
                    updateStatus(`Processing ${i + 1} of ${names.length}: ${name}`);

                    // Load the original PDF bytes for each new document
                    const pdfDoc = await PDFDocument.load(pdfBytes);
                    
                    // Removed fontkit registration

                    // Embed the standard Helvetica font
                    const standardFont = await pdfDoc.embedFont(StandardFonts.Helvetica);
                    
                    const pages = pdfDoc.getPages();

                    // Add watermark to every page
                    for (const page of pages) {
                        await addWatermark(page, name, standardFont);
                    }

                    // Save the modified PDF as new bytes
                    const newPdfBytes = await pdfDoc.save();

                    // Add the new PDF to the zip file
                    zip.file(`${sanitizedName}_${pdfFile.name}`, newPdfBytes);
                }

                // 8. Generate and download ZIP
                updateStatus('Generating ZIP file... This may take a moment.');
                const zipBlob = await zip.generateAsync({ type: 'blob' });

                // Create a download link
                const link = document.createElement('a');
                link.href = URL.createObjectURL(zipBlob);
                link.download = 'watermarked_pdfs.zip';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                updateStatus(`Done! ${names.length} PDFs generated and zipped.`);

            } catch (error) {
                console.error(error);
                updateStatus(`Error: ${error.message}`, true);
            } finally {
                // 9. Re-enable button
                generateButton.disabled = false;
                generateButton.textContent = 'Generate Watermarked PDFs';
            }
        }
        
        // Helper to show messages to the user
        function updateStatus(message, isError = false) {
            status.textContent = message;
            status.style.display = 'block';
            status.style.color = isError ? '#dc2626' : '#4b5563'; // red-600 or gray-600
        }

    </script>
</body>
</html>



